<!DOCTYPE html>
<html>
<head>
    <title>Real-time Communication Test</title>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .log { background: #f0f0f0; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; }
        button { padding: 8px 15px; margin: 5px; }
        input { padding: 5px; margin: 5px; width: 300px; }
        .timestamp { color: #666; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>üîÑ Real-time Communication Test</h1>
    <p>This page tests different real-time patterns to understand the <strong>GET /hub</strong> long execution times seen in Datadog APM.</p>

    <!-- SignalR Test -->
    <div class="section">
        <h2>üì± SignalR Hub Test (/hub)</h2>
        <button onclick="connectSignalR()">Connect to Hub</button>
        <button onclick="disconnectSignalR()">Disconnect</button>
        <button onclick="sendHeartbeat()">Send Heartbeat</button>
        <div id="signalr-log" class="log"></div>
    </div>

    <!-- Long Polling Test -->
    <div class="section">
        <h2>‚è≥ Long Polling Test</h2>
        <input type="number" id="timeout" value="30" placeholder="Timeout (seconds)" />
        <button onclick="startLongPolling()">Start Long Polling</button>
        <button onclick="stopLongPolling()">Stop</button>
        <br>
        <input type="text" id="message" placeholder="Message to send" />
        <button onclick="sendMessage()">Send Message</button>
        <div id="longpoll-log" class="log"></div>
    </div>

    <!-- Server-Sent Events Test -->
    <div class="section">
        <h2>üì° Server-Sent Events Test</h2>
        <input type="number" id="sse-duration" value="30" placeholder="Duration (seconds)" />
        <button onclick="startSSE()">Start SSE Stream</button>
        <button onclick="stopSSE()">Stop SSE</button>
        <div id="sse-log" class="log"></div>
    </div>

    <!-- Hub Simulation Test -->
    <div class="section">
        <h2>üîÑ Hub Simulation Test (Recreate APM Pattern)</h2>
        <input type="number" id="delay" value="60" placeholder="Delay (seconds)" />
        <button onclick="simulateHub()">Simulate /hub Delay</button>
        <div id="hub-log" class="log"></div>
    </div>

    <script>
        let connection = null;
        let longPollAbortController = null;
        let eventSource = null;

        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const colorMap = {
                'info': '#333',
                'success': '#4CAF50',
                'error': '#F44336',
                'warning': '#FF9800'
            };
            
            logElement.innerHTML += `<div style="color: ${colorMap[type]}">
                <span class="timestamp">[${timestamp}]</span> ${message}
            </div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // SignalR Functions
        async function connectSignalR() {
            try {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/hub")
                    .build();

                connection.on("UserJoined", (message) => {
                    log('signalr-log', `üë§ ${message}`, 'info');
                });

                connection.on("ReceiveMessage", (user, message) => {
                    log('signalr-log', `üí¨ ${user}: ${message}`, 'info');
                });

                connection.on("Heartbeat", (timestamp) => {
                    log('signalr-log', `üíì Heartbeat: ${timestamp}`, 'success');
                });

                await connection.start();
                log('signalr-log', "‚úÖ Connected to SignalR Hub", 'success');
                
                // Join a test room
                await connection.invoke("JoinRoom", "testroom");
                
            } catch (err) {
                log('signalr-log', `‚ùå SignalR Error: ${err}`, 'error');
            }
        }

        async function disconnectSignalR() {
            if (connection) {
                await connection.stop();
                log('signalr-log', "üîå Disconnected from SignalR Hub", 'warning');
            }
        }

        async function sendHeartbeat() {
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                await connection.invoke("SendHeartbeat");
            } else {
                log('signalr-log', "‚ùå Not connected to hub", 'error');
            }
        }

        // Long Polling Functions
        async function startLongPolling() {
            const timeout = document.getElementById('timeout').value;
            longPollAbortController = new AbortController();
            
            log('longpoll-log', `üîÑ Starting long polling (timeout: ${timeout}s)...`, 'info');
            
            try {
                const startTime = Date.now();
                const response = await fetch(`/api/realtime/long-polling?timeoutSeconds=${timeout}`, {
                    signal: longPollAbortController.signal
                });
                const data = await response.json();
                const duration = (Date.now() - startTime) / 1000;
                
                log('longpoll-log', `‚úÖ Long polling completed in ${duration.toFixed(1)}s`, 'success');
                log('longpoll-log', `üìã Messages: ${JSON.stringify(data.messages)}`, 'info');
                
            } catch (err) {
                if (err.name === 'AbortError') {
                    log('longpoll-log', "‚èπÔ∏è Long polling stopped by user", 'warning');
                } else {
                    log('longpoll-log', `‚ùå Long polling error: ${err}`, 'error');
                }
            }
        }

        function stopLongPolling() {
            if (longPollAbortController) {
                longPollAbortController.abort();
            }
        }

        async function sendMessage() {
            const message = document.getElementById('message').value;
            if (!message) return;
            
            try {
                const response = await fetch('/api/realtime/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();
                log('longpoll-log', `üì® Message sent: "${message}" (total: ${data.messageCount})`, 'success');
                document.getElementById('message').value = '';
            } catch (err) {
                log('longpoll-log', `‚ùå Send message error: ${err}`, 'error');
            }
        }

        // Server-Sent Events Functions
        function startSSE() {
            const duration = document.getElementById('sse-duration').value;
            
            if (eventSource) {
                eventSource.close();
            }
            
            log('sse-log', `üì° Starting SSE stream (duration: ${duration}s)...`, 'info');
            
            eventSource = new EventSource(`/api/realtime/sse?durationSeconds=${duration}`);
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                log('sse-log', `üìä ${data.message} (elapsed: ${data.elapsed.toFixed(1)}s)`, 'info');
            };
            
            eventSource.onerror = function(event) {
                log('sse-log', "‚ùå SSE error or stream ended", 'error');
                eventSource.close();
            };
        }

        function stopSSE() {
            if (eventSource) {
                eventSource.close();
                log('sse-log', "‚èπÔ∏è SSE stream stopped", 'warning');
            }
        }

        // Hub Simulation Functions
        async function simulateHub() {
            const delay = document.getElementById('delay').value;
            
            log('hub-log', `üîÑ Starting hub simulation (${delay}s delay) - similar to APM trace...`, 'info');
            
            try {
                const startTime = Date.now();
                const response = await fetch(`/api/realtime/hub?delaySeconds=${delay}`);
                const data = await response.json();
                const actualDuration = (Date.now() - startTime) / 1000;
                
                log('hub-log', `‚úÖ Hub simulation completed!`, 'success');
                log('hub-log', `‚è±Ô∏è Requested: ${delay}s, Actual: ${actualDuration.toFixed(1)}s`, 'info');
                log('hub-log', `üìã Response: ${JSON.stringify(data)}`, 'info');
                
            } catch (err) {
                log('hub-log', `‚ùå Hub simulation error: ${err}`, 'error');
            }
        }

        // Quick test function
        async function quickTest() {
            try {
                const startTime = Date.now();
                const response = await fetch('/api/realtime/quick');
                const data = await response.json();
                const duration = Date.now() - startTime;
                
                console.log(`‚ö° Quick response: ${duration}ms`, data);
            } catch (err) {
                console.error('Quick test error:', err);
            }
        }

        // Auto-run quick test on load
        window.onload = function() {
            quickTest();
            log('signalr-log', "üîÑ SignalR Hub Test Ready", 'info');
            log('longpoll-log', "‚è≥ Long Polling Test Ready", 'info');
            log('sse-log', "üì° Server-Sent Events Test Ready", 'info');
            log('hub-log', "üîÑ Hub Simulation Test Ready", 'info');
        };
    </script>
</body>
</html>